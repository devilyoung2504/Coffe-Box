name: QualityRisk (Delta + Tests + Sonar Evidence)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  qualityrisk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install -U pip
          if [ -f qualityrisk/requirements.txt ]; then
            pip install -r qualityrisk/requirements.txt
          else
            pip install requests pyyaml
          fi

      # -----------------------
      # Tests (sem√°nticos)
      # -----------------------
      - name: Setup Node (only if package.json exists)
        if: ${{ hashFiles('package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps (Node)
        if: ${{ hashFiles('package.json') != '' }}
        run: npm ci

      - name: Run tests (capture JSON)
        if: ${{ hashFiles('package.json') != '' }}
        run: |
          mkdir -p qualityrisk/out
          python qualityrisk/scripts/run_cmd_capture.py \
            --name "npm_test" \
            --out qualityrisk/out/test_report.json \
            -- npm test

      - name: Ensure test report exists (when no Node project)
        if: ${{ hashFiles('package.json') == '' }}
        run: |
          mkdir -p qualityrisk/out
          python - << 'PY'
          import json, pathlib, time
          p = pathlib.Path("qualityrisk/out/test_report.json")
          p.write_text(json.dumps({
            "name": "npm_test",
            "started_at": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
            "duration_ms": 0,
            "exit_code": 0,
            "tests_present": False,
            "tests_passed": False,
            "signals": {
              "has_test_files": False,
              "test_files_sample": [],
              "output_mentions_tests": False,
              "output_says_no_tests": False
            },
            "stdout": "",
            "stderr": "No package.json found, tests skipped",
            "truncated": {"stdout": False, "stderr": False}
          }, indent=2), encoding="utf-8")
          PY

      # -----------------------
      # Delta (antes de Sonar)
      # -----------------------
      - name: Build Delta JSON
        run: |
          mkdir -p qualityrisk/out
          python qualityrisk/scripts/delta_analyzer.py \
            --base "${{ github.event.pull_request.base.sha }}" \
            --head "${{ github.event.pull_request.head.sha }}" \
            --out qualityrisk/out/delta.json

      # -----------------------
      # Select policy by scope (web vs tooling)
      # -----------------------
      - name: Select Policy (scope-aware)
        id: policy
        run: |
          mkdir -p qualityrisk/out
          python qualityrisk/scripts/policy_select.py \
            --delta qualityrisk/out/delta.json \
            --web-policy qualityrisk/rules/policy_web_static_v1.yml \
            --tooling-policy qualityrisk/rules/policy_tooling_qualityrisk_v1.yml \
            --out qualityrisk/out/selected_policy.txt

          echo "policy=$(cat qualityrisk/out/selected_policy.txt | tr -d '\n')" >> $GITHUB_OUTPUT

      # -----------------------
      # Sonar (solo PRs no-fork)
      # -----------------------
      - name: SonarCloud scan
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        continue-on-error: true
        uses: SonarSource/sonarqube-scan-action@v7
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.sources=.
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/.venv/**,**/.tox/**,**/docs/**,**/sql/**,**/qualityrisk/out/**

      - name: Fetch Sonar JSON (filtered by delta)
        if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mkdir -p qualityrisk/out
          python qualityrisk/scripts/sonar_fetch.py \
            --project-key "${{ secrets.SONAR_PROJECT_KEY }}" \
            --pr "${{ github.event.pull_request.number }}" \
            --delta qualityrisk/out/delta.json \
            --out qualityrisk/out/sonar.json

      - name: Ensure sonar.json exists (when Sonar skipped)
        if: ${{ github.event.pull_request.head.repo.full_name != github.repository }}
        run: |
          mkdir -p qualityrisk/out
          python - << 'PY'
          import json, pathlib, time
          p = pathlib.Path("qualityrisk/out/sonar.json")
          p.write_text(json.dumps({
            "meta": {
              "generated_at": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
              "tool": "qualityrisk.sonar_fetch",
              "version": "stub"
            },
            "projectKey": "unknown",
            "pullRequest": "unknown",
            "qualityGate": {"status": "NONE"},
            "issues": [],
            "issues_count": 0,
            "issues_filtered_by_delta": [],
            "issues_filtered_count": 0,
            "filter_stats": None
          }, indent=2), encoding="utf-8")
          PY

      # -----------------------
      # Risk Score (scope-aware via selected policy)
      # -----------------------
      - name: Build Risk Score JSON
        run: |
          mkdir -p qualityrisk/out
          python qualityrisk/scripts/risk_score.py \
            --delta qualityrisk/out/delta.json \
            --tests qualityrisk/out/test_report.json \
            --sonar qualityrisk/out/sonar.json \
            --policy "${{ steps.policy.outputs.policy }}" \
            --out qualityrisk/out/risk_score.json

      # -----------------------
      # Evidence Pack (base)
      # -----------------------
      - name: Build Evidence Pack JSON (base)
        run: |
          mkdir -p qualityrisk/out
          python qualityrisk/scripts/build_evidence_pack.py \
            --repo "${{ github.repository }}" \
            --pr "${{ github.event.pull_request.number }}" \
            --base "${{ github.event.pull_request.base.sha }}" \
            --head "${{ github.event.pull_request.head.sha }}" \
            --delta qualityrisk/out/delta.json \
            --sonar qualityrisk/out/sonar.json \
            --tests qualityrisk/out/test_report.json \
            --risk qualityrisk/out/risk_score.json \
            --out qualityrisk/out/evidence_pack.json

      # -----------------------
      # Policies / Golden Path
      # -----------------------
      - name: Evaluate Policy (Golden Path)
        run: |
          mkdir -p qualityrisk/out
          python qualityrisk/scripts/policy_eval.py \
            --policy "${{ steps.policy.outputs.policy }}" \
            --evidence qualityrisk/out/evidence_pack.json \
            --risk qualityrisk/out/risk_score.json \
            --out qualityrisk/out/policy_result.json

      # -----------------------
      # Evidence Pack (final con policy)
      # -----------------------
      - name: Build Evidence Pack JSON (final)
        run: |
          mkdir -p qualityrisk/out
          python qualityrisk/scripts/build_evidence_pack.py \
            --repo "${{ github.repository }}" \
            --pr "${{ github.event.pull_request.number }}" \
            --base "${{ github.event.pull_request.base.sha }}" \
            --head "${{ github.event.pull_request.head.sha }}" \
            --delta qualityrisk/out/delta.json \
            --sonar qualityrisk/out/sonar.json \
            --tests qualityrisk/out/test_report.json \
            --risk qualityrisk/out/risk_score.json \
            --policy-result qualityrisk/out/policy_result.json \
            --out qualityrisk/out/evidence_pack.json

      # -----------------------
      # PR report (summary + comment)
      # -----------------------
      - name: Render QualityRisk report (markdown)
        run: |
          python qualityrisk/scripts/pr_comment.py \
            --repo "${{ github.repository }}" \
            --pr "${{ github.event.pull_request.number }}" \
            --evidence qualityrisk/out/evidence_pack.json \
            --out-md qualityrisk/out/qualityrisk_report.md \
            --dry-run

      - name: Publish report to job summary
        run: |
          cat qualityrisk/out/qualityrisk_report.md >> $GITHUB_STEP_SUMMARY

      - name: Post/Update PR comment (QualityRisk)
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          python qualityrisk/scripts/pr_comment.py \
            --repo "${{ github.repository }}" \
            --pr "${{ github.event.pull_request.number }}" \
            --evidence qualityrisk/out/evidence_pack.json \
            --out-md qualityrisk/out/qualityrisk_report.md

      # -----------------------
      # Enforce policy (solo si mode=enforcing)
      # -----------------------
      - name: Enforce policy (mode=enforcing only)
        run: |
          python qualityrisk/scripts/gate_enforce.py \
            --policy-result qualityrisk/out/policy_result.json

      # -----------------------
      # Upload artifacts
      # -----------------------
      - name: Upload Evidence Pack (artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: qualityrisk-evidence
          path: qualityrisk/out/*
